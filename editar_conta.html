<!DOCTYPE html>
<html>
  <head>
    <title>E-Li$t Editar Senha</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="css/Style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Monoton&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/telacadastro.css">
  </head>
  <style> 
    .logo {
        max-height: 60px;
    }
      .botao-deletar {
          background-color: #dc3545;
          color: white;
          border: none;
          padding: 12px 24px;
          font-size: 16px;
          font-weight: 600;
          border-radius: 6px;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-top: 20px;
          box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
      }

          .botao-deletar:hover {
              background-color: #c82333;
              transform: translateY(-2px);
              box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
          }

          .botao-deletar:active {
              transform: translateY(0);
              box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
          }

          .botao-deletar:focus {
              outline: none;
              box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25);
          }
</style>

  <body>
    <div id="parte1">
      <header>
        <nav class="navbar navbar-expand-lg">
          <div class="container-fluid">            
            <img class="logo" src="img/coopgologowide.jpg" href="#"></img>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <img src="imgs/Icons/view-headline.png"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">                 
                </li>
                <li class="nav-item">
                </li>
              </ul>
              <li class="d-flex">                
                <div class="modoescuro"><a onclick="myFunction()"> 
                  <img src="imgs/Icons/circle-slice-4.png"> </a></div>        
              </li>
            </div>
          </div>
        </nav>     
     </header>
    </div>
    <div id="parte2">
        <div class="titulo">
            <h1>Editar Conta</h1>
        </div>
        <div class="img">
            <img src="imgs/cadastro-de-usuario.svg" height="400px">
        </div>
        <form id="alterar-form">
            <fieldset>
                <input type="text" name="nome" id="nome" placeholder="Nome">
                <input type="password" name="novaSenha" id="novaSenha" placeholder="Nova Senha">
                <button class="botao" type="submit" onclick="alterarConta();" ;>Alterar</button>
            </fieldset>
        </form>
        <button class="botao-deletar" type="button" onclick="deletarConta();">
            Excluir Minha Conta
        </button>
    </div>
    <footer>            
      <p> 
        COOPGO &copy 2025 Copyright Todos os direitos reservados 
      </p>
    </footer>
    <script>
      function myFunction() {
         var element = document.body;
         element.classList.toggle("dark-mode");
        }

        function alterarConta() {
            // Previne o comportamento padrão
            event.preventDefault();

            // Verifica se o usuário está logado
            const usuarioLogado = localStorage.getItem('usuarioLogado');
            if (!usuarioLogado) {
                alert('Você precisa estar logado para alterar sua conta.');
                window.location.href = 'index.html';
                return;
            }

            // Pega o ID do usuário logado
            const usuario = JSON.parse(usuarioLogado);

            // Captura os valores dos inputs
            const novoNome = document.getElementById('nome').value;
            const novaSenha = document.getElementById('novaSenha').value;

            // Validação básica
            if (!novoNome || !novaSenha) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            // Cria o objeto com os dados atualizados
            const dadosAtualizados = {
                id: usuario.id,
                nome: novoNome,
                senha: novaSenha
            };

            // Faz a requisição POST para a API
            fetch('https://localhost:44344/api/App/Alterar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(dadosAtualizados)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.sucesso) {
                        // Atualiza o sessionStorage com o novo nome
                        const usuarioAtualizado = {
                            id: usuario.id,
                            nome: novoNome
                        };
                        localStorage.setItem('usuarioLogado', JSON.stringify(usuarioAtualizado));

                        alert('Conta alterada com sucesso!');

                        // Limpa os campos
                        document.getElementById('nome').value = '';
                        document.getElementById('novaSenha').value = '';

                        // Opcional: redirecionar para o dashboard
                        // window.location.href = 'dashboard.html';
                    } else {
                        alert(data.mensagem || 'Erro ao alterar conta.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao alterar conta:', error);
                    alert('Erro ao alterar conta. Por favor, tente novamente.');
                });
        }

        function deletarConta() {
            // Verifica se o usuário está logado
            const usuarioLogado = localStorage.getItem('usuarioLogado');
            if (!usuarioLogado) {
                alert('Você precisa estar logado para excluir sua conta.');
                window.location.href = 'index.html';
                return;
            }

            // Pega o ID do usuário logado
            const usuario = JSON.parse(usuarioLogado);

            // Confirmação dupla para evitar exclusão acidental
            const primeiraConfirmacao = confirm('Tem certeza que deseja excluir sua conta? Esta ação não pode ser desfeita.');

            if (!primeiraConfirmacao) {
                return;
            }

            const segundaConfirmacao = confirm('Esta é sua última chance. Deseja realmente excluir sua conta permanentemente?');

            if (!segundaConfirmacao) {
                return;
            }

            // Objeto com o ID do usuário
            const dadosExclusao = {
                id: usuario.id
            };

            // Faz a requisição DELETE para a API
            fetch('https://localhost:44344/api/App/DeletarUsuario', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(dadosExclusao)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.sucesso) {
                        // Remove o usuário do localStorage
                        localStorage.removeItem('usuarioLogado');

                        alert('Sua conta foi excluída com sucesso.');

                        // Redireciona para a página de login
                        window.location.href = 'index.html';
                    } else {
                        alert(data.mensagem || 'Erro ao excluir conta.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao excluir conta:', error);
                    alert('Erro ao excluir conta. Por favor, tente novamente.');
                });
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>

  </body>
  </html>
